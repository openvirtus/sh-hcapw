#!/bin/sh
#L:
#L:  This software is free to use and modify, but not free to maintain.
#L:
#l:  Donate bitcoin: 1C1ZzDje7vHhF23mxqfcACE8QD4nqxywiV
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#r: ## HCAPW
#r:
#h: Usage: $0 [-i INTF][-I] [USER@]HOSTNAME|localhost [WIRESHARK ARGS...]
#h:
#h: Capture network traffic in a remote machine tunneling "tcpdump". You can
#h: ensure "tcpdump" is 
#h:
#h: -I      : Install Wireshark.
#h: -i INTF : Capture for interface.
#r:
hcapw() {
    ## Parse command line arguments.
    local OPTIND optopt= ops= intf=any do_install=n
    while getopts "Ii:" optopt;do # OPTARG
        case "${optopt}" in
            i)  local intf="${OPTARG}" ;;
            I)  local do_install="y"   ;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Get hostname.
    local hostname="$1"
    if test ! -n "${hostname}";then
        return 0
    fi
    shift
    ## Code to install tcpdump.
    local icode="
    if sudo which tcpdump >/dev/null 2>&1;then
        echo 'TCPDUMP already installed in ${hostname}' >&2
    elif test -f /usr/bin/apt-get;then
        sudo apt-get -y install tcpdump
    elif test -f /usr/bin/yum;then
        sudo yum -y install tcpdump
    elif test -f /usr/bin/pacman;then
        sudo pacman -Sy tcpdump
    elif test -f /usr/bin/xbps-install;then
        sudo /usr/bin/xbps-install -Ry tcpdump
    else
        echo 'Do not know how to install 'tcpdump'.' >&2
        exit 1
    fi
    if test -f /usr/bin/yum;then
        sudo usermod -a -G wireshark \$USER 2>/dev/null
    fi"
    ## Perform operations.
    if test @"${do_install}" = @"y" && hcapw_is_local "${hostname}";then
        sh -c "${icode}"
    elif test @"${do_install}" = @"y";then
        ssh -t "${hostname}" "${icode}"
    elif hcapw_is_local "${hostname}";then
        sudo wireshark -k -i "${intf}" $@
    else
        local c1="tcpdump -s 0 -U -n -w - -i '${intf}' 'not port 22'"
        local c2="wireshark -i - -k $*"
        echo "Remote : sudo ${c1}" >&2
        echo "Local  : sudo ${c2}" >&2
        hcapw_sudo true ## Ask password, no (-t), invalid input.
        ssh "${hostname}" "sudo ${c1}" | hcapw_sudo sh -c "${c2}"
    fi
}
hcapw_is_local() {
    local host="`echo "${1}" | sed 's|.*@||'`"
    test @"${host}" = @"127.0.0.1" || test @"${host}" = @"localhost"
}
hcapw_sudo() {
    /usr/bin/sudo \
        LD_LIBRARY_PATH=/usr/lib:/usr/lib/x86_64-linux-gnu \
        "$@"
}







## --------------------------------------------------------------------------------
if test @"`basename "$0"`" = @"hcapw";then
    if test -n "$1";then
        hcapw "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,2\}//p' "$0"
    fi
fi
